import tkinter as tk
from tkinter import messagebox
import os
import subprocess
import sys
import win32gui
import win32process
import psutil

def kill_process_by_window_title(titles_to_kill):
    """æ ¹æ®çª—å£æ ‡é¢˜å…³é—­æŒ‡å®šç¨‹åº"""
    def enum_windows_callback(hwnd, _):
        if win32gui.IsWindowVisible(hwnd):
            window_title = win32gui.GetWindowText(hwnd)
            # è·å–çª—å£å¯¹åº”çš„è¿›ç¨‹å
            try:
                _, pid = win32process.GetWindowThreadProcessId(hwnd)
                process = psutil.Process(pid)
                process_name = process.name().lower()
                
                # æ£€æŸ¥æ˜¯å¦åŒ¹é…ç›®æ ‡çª—å£æˆ–è¿›ç¨‹
                for title in titles_to_kill:
                    if (title.lower() in window_title.lower() or 
                        title.lower() in process_name):
                        try:
                            process.terminate()  # å…ˆå°è¯•ä¼˜é›…é€€å‡º
                            print(f"å·²å…³é—­: {window_title} ({process_name})")
                        except:
                            try:
                                process.kill()  # å¼ºåˆ¶ç»“æŸ
                            except:
                                pass
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                pass
        return True

    win32gui.EnumWindows(enum_windows_callback, None)

def emergency_exit():
    """ç´§æ€¥æ¨¡å¼ï¼šä¸€é”®æ¸…ç† + é€€å‡º"""
    # è¦å…³é—­çš„ç›®æ ‡ï¼ˆæ”¯æŒçª—å£æ ‡é¢˜å…³é”®è¯å’Œè¿›ç¨‹åï¼‰
    targets = [
        "Edge", "Microsoft Edge",
        "è®°äº‹æœ¬", "notepad", "æ— æ ‡é¢˜ - è®°äº‹æœ¬",
        "å‘½ä»¤æç¤ºç¬¦", "cmd", "å‘½ä»¤è¡Œ"
    ]
    
    kill_process_by_window_title(targets)
    
    # ç»™ç‚¹åé¦ˆï¼Œå®‰å¿ƒä¸€ä¸‹
    messagebox.showinfo("ğŸ›¡ï¸ å®‰å…¨äº†ï¼", "å·²æ¸…ç†å¯ç–‘çª—å£\nå¯ä»¥å‡è£…åœ¨æ‘¸é±¼äº†ï½")
    
    # å…³é—­è‡ªå·±
    root.quit()
    root.destroy()

# åˆ›å»ºä¸»çª—å£
root = tk.Tk()
root.title("ğŸš¨ è€æ¿æ¥äº†ï¼Ÿ")
root.geometry("200x80")
root.attributes('-topmost', True)  # çª—å£ç½®é¡¶
root.resizable(False, False)

# è®¾ç½®æŒ‰é’®
btn = tk.Button(
    root,
    text="âš ï¸ è€æ¿æ¥äº†ï¼",
    font=("å¾®è½¯é›…é»‘", 12, "bold"),
    bg="#FF6B6B",
    fg="white",
    activebackground="#EE5253",
    command=emergency_exit,
    relief="raised",
    bd=3
)
btn.pack(expand=True, fill='both', padx=10, pady=10)

# å¿«æ·é”®æ”¯æŒï¼šæŒ‰ F12 ä¹Ÿèƒ½è§¦å‘ï¼ˆæ›´éšè”½ï¼‰
root.bind('<F12>', lambda e: emergency_exit())

# å¯åŠ¨å‰æç¤ºä¸€æ¬¡ï¼ˆç¬¬ä¸€æ¬¡è¿è¡Œæ—¶æé†’ï¼‰
def show_first_tip():
    messagebox.showinfo(
        "ğŸ“Œ ä½¿ç”¨è¯´æ˜",
        "ç‚¹å‡»æŒ‰é’®æˆ–æŒ‰ F12 é”®\nç«‹å³å…³é—­ Edgeã€è®°äº‹æœ¬ã€CMD\nçª—å£ä¼šè‡ªåŠ¨æ¶ˆå¤±\nä¸‹æ¬¡å¯åŠ¨ä¸å†æç¤º"
    )
    # è¿™é‡Œä½ å¯ä»¥åŠ ä¸ªé…ç½®æ–‡ä»¶è®°å½•æ˜¯å¦é¦–æ¬¡è¿è¡Œï¼Œæˆ‘ä»¬ç®€åŒ–å¤„ç†å°±ä¸å†™äº†

# å»¶è¿Ÿæ˜¾ç¤ºæç¤ºï¼ˆé¿å…å¼¹å¤ªå¿«ï¼‰
root.after(100, show_first_tip)

# è¿è¡Œä¸»å¾ªç¯
try:
    root.mainloop()
except:
    pass
finally:
    sys.exit()